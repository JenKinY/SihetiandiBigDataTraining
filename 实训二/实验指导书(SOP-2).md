# 手机数据分析实训二

难度等级：中等



## 一、项目简介

通过上一个任务，我们已经对大数据应用项目的工作流程中涉及到的基本技术技能进行了训练，通过上一个实训任务，我们得出了手机品牌、手机颜色及手机屏幕尺寸对与手机销量的影响。本章我们来尝试对手机销售数据进行更进一步的分析，包括各手机型号的销售时间情况、各销售渠道的销售量情况以及用户评分情况。



### 1.1 知识点

本实训内容涉及到以下知识点：

- 数据采集组件的配置
  - flume参数配置
- 数据采集
  - 使用工具（Chrome开发者工具）查看网页源码，分析网页结构，明确数据采集对象
  - 网络请求
  - 数据分析及提取
  - 本地目录操作、文件创建、读写
- 数据清洗
  - HDFS数据文件读取、解析、清洗过滤，分区
  - MapReduce程序的编译、打包、发布
  - 执行MapReduce程序，完成数据清洗
- 数据分析
  - Hive建库、建表
  - Hive数据加载
  - HQL编写、数据查询统计
- 数据分析及数据可视化
  - Flask网页后台代码编写
  - 基于Echarts的数据可视化渲染编码
- 数据分析报告编写

### 1.2 前期准备工作

为了能够顺利的完成本次实训任务，你至少需要了解以下基础知识：

- Python程序开发基础
- Java程序开发基础
- HTML、CSS、JavaScript等页面基础
- 了解基于Hadoop的离线大数据分析平台的运行机制
- MySQL数据库的远程连接、数据访问

## 二、数据集简介

本次训练所使用的数据集为某大型电子商务网站采集的手机数据，文件名称为jd.json，该数据包含了一部分数据缺失或不准确的脏数据，数据集文件中每一行数据为一个用户对其购买的手机的评论数据，数据格式为json，数据组织格式如下：

```
Data1
Data2
Data3
...
DataN
```

一条数据内容格式如下：

```
{
  'phone_brand': '小米（MI）',		// 手机品牌名称
  'phone_name': '小米红米6 Pro',	// 手机型号
  'parameter': [
    {
      '品牌': '小米（MI）',
      '型号': '红米6 Pro',
      '入网型号': '以官网信息为准',
      '上市年份': '2018年',
      '上市月份': '6月'
    },
    {
      '机身颜色': '曜石黑',
      '机身长度（mm）': '149.33',
      '机身宽度（mm）': '71.68',
      '机身厚度（mm）': '8.75',
      '机身重量（g）': '178',
      '运营商标志或内容': '无',
      '机身材质分类': '其他'
    },
    {
      '操作系统': 'Android'
    },
    {
      'CPU品牌': '骁龙（Snapdragon)',
      'CPU频率': '以官网信息为准',
      'CPU核数': '八核',
      'CPU型号': '骁龙625（MSM8953）'
    },
    {
      '双卡机类型': '双卡双待单通',
      '最大支持SIM卡数量': '2个',
      'SIM卡类型': 'Nano SIM',
      '4G网络': '4G：移动（TD-LTE)；4G：联通(FDD-LTE)；4G：电信(FDD-LTE)；4G：联通(TD-LTE)',
      '3G/2G网络': '3G：移动(TD-SCDMA)；3G：联通(WCDMA)；3G：电信(CDMA2000)；2G：移动（GSM）+联通(GSM)；2G：电信(CDMA)；2G：移动联通(GSM)+电信(CDMA)',
      '副SIM卡4G网络': '不支持主副卡同时使用电信卡',
      '网络频率（2G/3G）': '2G：GSM 850/900/1800/1900；2G：CDMA 800；3G：TD-SCDMA 1900/2000；3G：WCDMA 850/900/1900/2100；3G：CDMA2000；2G：GSM 900/1800；2G：GSM 900/1800/1900；3G：CDMA 800MHz 1X&EVDO；3G：WCDMA：850/900/1700/1900/2100MHz',
      '是否支持同时使用联通卡': '不可同时上网，仅支持卡A上网，卡B通话。'
    },
    {
      'ROM': '32GB',
      'RAM': '3GB',
      '存储卡': '支持MicroSD（TF）',
      '最大存储扩展容量': '256GB'
    },
    {
      '主屏幕尺寸（英寸）': '5.84英寸',
      '分辨率': '2280x1080',
      '屏幕像素密度（ppi）': '432',
      '屏幕材质类型': '其他'
    },
    {
      '前置摄像头': '500万像素',
      '前摄光圈大小': '其他',
      '美颜技术': '支持',
      '拍照特点': '美颜'
    },
    {
      '摄像头数量': '2个',
      '后置摄像头': '1200+500万像素',
      '摄像头光圈大小': 'f/2.2',
      '拍照特点': '美颜；连拍；全景；夜间拍摄'
    },
    {
      '电池容量（mAh）': '4000mAh（typ）/3900mAh（min）',
      '电池是否可拆卸': '否',
      '充电器': '5V/2A'
    },
    {
      '数据传输接口': '蓝牙',
      'NFC/NFC模式': '不支持',
      '耳机接口类型': '3.5mm',
      '充电接口类型': 'Micro USB'
    },
    {
      '指纹识别': '支持',
      'GPS': '支持',
      '陀螺仪': '支持',
      '其他': '距离感应；光线感应'
    },
    {
      '常用功能': '录音；便签；超大字体'
    }
  ],
  'comments': {
    'comment_user': '爱***包',				// 评论用户
    'appraise': '很棒哦，超级喜欢啊...',		   // 用户评论内容
    'buy_color': '曜石黑',					   // 用户购买的手机他颜色
    'buy_size': '3GB+32GB',			 		 // 用户购买的手机型号
    'buy_date': '2018-09-17 15:23:44',		 // 用户购买时间
    'buy_client': '来自京东iPhone客户端',		// 用户购买渠道
    'score': 5,								 // 用户评分
    'upvote': 1								 // 用户评论点赞数量
  }
}
```



# 三、运行环境

| 名称       | 硬件      | 软件                     | IP地址        | 用途                                                  |
| ---------- | :-------- | ------------------------ | ------------- | ----------------------------------------------------- |
| Master     | 内存：16G | CentOS7，Hadoop组件      | 192.168.3.100 | 离线分析系统集群主节点                                |
| Slave1     | 内存：8G  | CentOS7，Hadoop组件      | 192.168.3.101 | 离线分析系统集群从节点                                |
| Slave2     | 内存：8G  | CentOS7，Hadoop组件      | 192.168.3.102 | 离线分析系统集群从节点                                |
| DS-Dev     | 内存：4G  | Ubuntu 16.04LTS，PyCharm | 192.168.3.120 | 用于完成数据采集相关开发、调试工作的客户端环境        |
| DA-Dev     | 内存：4G  | Ubuntu 16.04LTS，IDEA    | 192.168.3.121 | 用于完成MapReduce相关开发、调试、发布工作的客户端环境 |
| DV-Dev     | 内存：4G  | Ubuntu 16.04LTS，PyCharm | 192.168.3.122 | 用于完成数据可视化相关开发、调试工作的客户端环境      |
| Web-Server | 内存：4G  | CentOS                   | 192.168.3.124 | 模拟电子商务网站，作为数据采集对象                    |



## 四、实训任务

从本章开始，我们将逐步完成一个大数据离线分析项目的全部工作过程，请按照指定的任务步骤完成所有任务，全部实训任务需要在**4小时内**完成，祝各位好运。

### 任务一、数据采集组件Flume配置

大数据离线分析系统集群已初步部署完成，离线分析集群采用完全分布式模式部署，包括1台Master和2台Slave。大数据平台已安装部署的组件包括：

- HDFS
- Hive
- Yarn
- Zookeeper
- Flume

按照大数据离线分析平台需求，需要完成数据采集组件Flume的配置，请按照如下步骤完成组件配置及可用性检测：

#### 1.  Flume参数配置

修改Slave1下Flume的安装目录下的配置文件，设置Sqoop和 Apache Atlas集成的相关配置

配置文件路径：`/opt/cloudera/parcels/CDH-5.14.0-1.cdh5.14.0.p0.24/etc/sqoop/conf.dist/sqoop-site.xml`

- atlas.rest.address：http://localhost:21000

- atlas cluster名称：primary

#### 2. 构建Flume Agent配置文件

- 创建agent配置文件，文件名为flumec.conf

- 分别定义：

  - agent

  - source

    ```
    类型：netcat
    ip:192.168.3.101
    端口：55555
    ```

  - channel

    ```类型：memory
    capacity:1000
    transactionCapacity：1000
    keep-alive=30
    ```

  - sink名称

    ```
    数据落地路径：hdfs:/Initial_Data/%Y%m%d 
    文件名前缀：%Y%m%d-
    文件生成规则：每分钟生成一个文件/每10M一个文件
    ```



### 任务二、数据采集

根据需求，需要对目标电子商务网站的数据进行采集，目标电子商务网站网址为`http://192.168.3.124:28080/LexianMall/sc/index.html`，请使用Chrome浏览器提供的开发者工具分析网页源代码，完成数据采集代码的编写，运行数据采集程序，完成数据采集工作。

#### 1. 使用Chrome浏览器打开网页，确定以下采集内容标签：

- 限时抢购
- 品牌精选
- 热卖推荐
- 新品上市
- 特色产品
- 秒杀商品

#### 2. 使用PyCharm打开`Pr_Task2_2`项目，完成`crawl.py`文件的以下函数实现：

- **def response_handler(self, url,data)**

  - 功能

    使用目标网页Url或接口构造Response对象

  - 参数

    url,目标网页的Url,数据类型String;

    data,post请求的参数,数据类型Dict

  - 返回值

    response,Response对象,数据类型Response Object

- **def parse(self, response)**
  - 功能

    使用Xpath对Response对象进行解析，形成结构化数据

  - 参数

    response,Response对象,数据类型:Response Object

  - 返回值

    items,解析得到的数据,数据类型:Object，数据格式:[{'name':'名称','price':'价格'},{'name':'名称','price':'价格'}]

- **def save_data(self, data)**
  - 功能

    将数据存储到项目目录文件下的`Pr_Task2_2-{YYYY-MM-DD}-crawl_data.json`文件当中去，其中文件的创建在该类的初始化呢函数内使用datetime模块生成

  - 参数

    item,单条数据由items迭代产生,数据类型:Dict，数据格式{'name': 'name', 'price': price, 'category': 'category'}

  - 返回值

    无

- **def crawl(self,url,category)**

  - 功能

    根据传入的分类及分类ID 向接口发送请求，获取响应并解析数据，然后将category字段插入后对数据进行存储。

  - 参数

    url,目标网页的Url或接口的API ,数据类型String;category，说明：商品分类，数据类型：String。

  - 返回值

    无

### 任务三、数据清洗

从目标电子网站采集到的数据保存在HDFS的`/Initial_Data/`目录下，根据项目需求，需要对采集到的数据进行不合规数据的清洗工作。请完成MapReduce程序的代码编写、程序打包发布并在服务器运行完成数据清洗工作。

#### 1.  使用IDEA打开`Pr_Task2_3`项目，完成`\src\main\java\PhoneMR\Phone_Map_2.java`文件的以下函数的编码实现：

- **PrePprocessData(String value)**

  - 功能

    处理一条数据中的特殊字符，清洗规则如下：

    - 将字符`|`替换为`-`
    - 将特殊字符串`\r\t`删除

  - 参数

    | 参数名 | 数据类型 | 说明     |
    | ------ | -------- | -------- |
    | value  | String   | 原始数据 |

  - 返回值

    | 返回值名 | 数据类型 | 说明           |
    | -------- | -------- | -------------- |
    | -        | String   | 处理完成的数据 |

- **GetStrigByPhoneBrand(String rawJson, String keysName)**

  - 功能

    解析JSON格式数据，根据数如参数从JSON中提取目标字符串

  - 参数

    | 参数名   | 数据类型 | 说明                  |
    | -------- | -------- | --------------------- |
    | rawJson  | String   | 原始JSON格式字符串    |
    | keysName | String   | 要提取的数据的Key名称 |

  - 返回值

    | 返回值名 | 数据类型 | 说明                                                         |
    | -------- | -------- | ------------------------------------------------------------ |
    | -        | String   | 提取到的字符串，若Key存在，则返回数据，若Key不存在则返回空字符串 |

- **GetStrigByPhoneName(String rawJson)**

  - 功能

    解析JSON格式数据，根据数如参数从JSON中提取目标字符串

  - 参数

    | 参数名  | 数据类型 | 说明               |
    | ------- | -------- | ------------------ |
    | rawJson | String   | 原始JSON格式字符串 |

  - 返回值

    | 返回值名 | 数据类型 | 说明                                                         |
    | -------- | -------- | ------------------------------------------------------------ |
    | -        | String   | 提取到的字符串，若Key存在，则返回数据，若Key不存在则返回空字符串 |


- **GetPhoneComment(String rawJson,String KeyName)**

  - 功能

    将传入参数整理为以下格式：

  - 参数

  - 参数名

  - 返回值

    | 返回值名 | 数据类型 | 说明         |
    | -------- | -------- | ------------ |
    | buy_date | String   | 购买手机时间 |

### 2. 完成`\src\main\java\PhoneMR\Phone_Driver_2.java`文件的以下函数的编码实现


- **Jobs(Job job)**

  - 功能

    设置输出的key，value的类型

  - 参数

    job， Job， MapReduce程序运行对象

  - 返回值 

    无

#### 2. 使用IDEA完成MapReduce程序的打包编译工作，生成程序包，程序包名称为`Pr_Task2_3.jar`

#### 3. 请将打包后的清洗程序包`Pr_Task2_3.jar`上传到Master主机的`/home`目录下，使用shell命令运行程序，完成数据清洗。



### 任务四、数据分析

大数据分析平台通过运行MapReduce程序已成功将不合规数据清洗完成，根据项目需求，需要将清洗后的数据加载到Hive数据仓库中进行数据分析工作。请完成以下各步骤工作：

#### 1. 按照以下要求创建数据仓库及Hive表

- 数据仓库名称：db_phone_raw_2

- 表名称：tbl_phone_data_2

  - 原始数据表

    - 表名称：tbl_phone_data_2

    - 结构：内部表

      | 列名              | 数据类型 |     说明     |
      | ----------------- | -------- | :----------: |
      | fld_brand_name    | String   |     品牌     |
      | fld_phone_name    | String   |   手机名称   |
      | fld_sales_time    | string   | 用户购买时间 |
      | fld_sales_channel | string   |   销售渠道   |
      | fld_user_score    | string   |   用户评分   |

  - 手机型号销售时间统计表

    - 表名称：tbl_sales_time_count

    - 结构：内部表

      | 字段名         | 属性   | 说明         |
      | -------------- | ------ | ------------ |
      | fld_phone_name | string | 手机名称     |
      | fld_sales_time | string | 用户购买时间 |
      | fld_sale_count | int    | 销售量       |

  - 手机销量渠道统计表

    - 表名称：tbl_Sales_Channel_Count

    - 结构：内部表

      | 字段名            | 属性   | 说明     |
      | ----------------- | ------ | -------- |
      | fld_phone_name    | string | 手机名称 |
      | fld_sales_channel | string | 销售渠道 |
      | fld_sale_count    | int    | 销售量   |

  - 手机用户评分统计表

    - 表名称：tbl_User_Score_Count

    - 结构：内部表

      | 字段名         | 属性   | 说明     |
      | -------------- | ------ | -------- |
      | fld_phone_name | string | 手机名称 |
      | fld_sale_count | int    | 销售量   |
      | fld_user_score | string | 用户评分 |

#### 2. 将HDFS的`/data/`下的全部数据加载到Hive表`tbl_phone_data_2`中

1. 下载附件中的数据文件，通过SSH命令上传到Slave2服务器
2. 使用HDFS命令创建目录`/data/`
3. 使用HDFS命令将文件上传到HDFS的`/data/`目录下
4. 使用Hive命令将数据加载到指定表中

#### 3. 运行HQL命令，统计以下数据

- 按照用户购买时间（精确到日）统计各手机型号的数量
- 按照用户购买渠道统计各手机型号的数量
- 统计销售量前十名的手机型号的平均用户评分




### 任务五、数据可视化

分析后的数据已推送到MySQL数据库中，MySQL数据库结构如下所示：

数据库名称：db_phone_analysis_data_2

- **表1：手机型号销售时间统计表**

  - 表名：tbl_sales_time_count

  - 表结构：

    | 字段名         | 属性               | 主键 | 外键 | 说明         |
    | -------------- | ------------------ | ---- | ---- | ------------ |
    | fld_index      | int，非空          | 是   | 否   | 自增字段     |
    | fld_phone_name | varchar(256)，非空 | 否   | 否   | 手机名称     |
    | fld_sales_time | varchar(256)，非空 | 否   | 否   | 用户购买时间 |
    | fld_sale_count | int，非空          | 否   | 否   | 销售量       |

- **表2：手机销量渠道统计表**

  - 表名：tbl_sales_channel_count

  - 表结构

    | 字段名            | 属性               | 主键 | 外键 | 说明     |
    | ----------------- | ------------------ | ---- | ---- | -------- |
    | fld_index         | int，非空          | 是   | 否   | 自增字段 |
    | fld_phone_name    | varchar(256)，非空 | 否   | 否   | 手机名称 |
    | fld_sales_channel | varchar(256)，非空 | 否   | 否   | 销售渠道 |
    | fld_sale_count    | int，非空          | 否   | 否   | 销售量   |

- 表3：手机用户评分统计表

  - 表名：tbl_user_score_count

  - 表结构：

    | 字段名         | 属性               | 主键 | 外键 | 说明     |
    | -------------- | ------------------ | ---- | ---- | -------- |
    | fld_index      | int，非空          | 是   | 否   | 自增字段 |
    | fld_phone_name | varchar(256)，非空 | 否   | 否   | 手机名称 |
    | fld_user_score | varchar(256)，非空 | 否   | 否   | 用户评分 |
    | fld_sale_count | int，非空          | 否   | 否   | 销售量   |

#### 1. 使用pycharm打开项目`Pr_task2_5`,完成以下文件的类定义：

- **get_sales_time_count()**

  - 功能：在./app/views/main.py文件中 编写方法get_sales_time_count()查询手机型号销售时间统计表tbl_sales_time_count中销售量排名前三的手机型号、销售量、销售时间数据。

  - 参数：

    | 参数名               | 数据类型 | 说明     |
    | -------------------- | -------- | -------- |
    | tbl_Sales_Time_Count | string   | 数据库表 |

  - 返回值：查询数据

- **get_sales_channel_count()**

  - 功能：在./app/views/main.py 文件中编写方法get_sales_channel_count()查询手机销量渠道统计表tbl_sales_channel_count中销售量排名前十的手机型号、销售量、销售渠道数据。

  - 参数：

    | 参数名                  | 数据类型 | 说明     |
    | ----------------------- | -------- | -------- |
    | tbl_Sales_Channel_Count | string   | 数据库表 |

  - 返回值：查询数据

- **get_user_score_count()**

  - 功能：在./app/views/main.py文件中编写 方法get_user_score_count()查询手机用户评分统计表tbl_user_score_count中手机销售量排名前十的用户评分、手机型号名称。（评分已算均值）

  - 参数：

    | 参数名               | 数据类型 | 说明     |
    | -------------------- | -------- | -------- |
    | tbl_User_Score_Count | string   | 数据库表 |

  - 返回值：查询数据

  #### 2.  完成`./app/templates/main/index.html`文件的以下函数编码实现：
  - **setSeries()**
    - 功能：对配置对象option中的series对象进行代码编写，其中需要做的是返回一个包含三个对象的数组，每个对象都是对三个手机型号中的其中一个手机型号进行配置，配置内容包括：
      - name:string
      - type:string
      - areaStyle:object、没有特殊设置时对象为空但要有占位
      - stack:string、三个对象中的stack是一样的都为销售量
      - data:array、每个手机型号在每个时间点内的销售量组成的数组

  ```
    其中方法内的参考写法如下：
    return [
                {
                    name: '',   //手机型号一名称
                    type: '',   //图表类型，本实例推荐使用折线图
                    areaStyle: ,//区域填充样式，可为空对象，但要占位
                    stack: '',  //数据堆叠，同个类目轴上系列配置相同的stack值
                    data:       //手机型号一相对应的销售量数据
                },
                {
                    name: '',   //手机型号二名称
                    type: '',   //图表类型，本实例推荐使用折线图
                    areaStyle: ,//区域填充样式，可为空对象，但要占位
                    stack: '', //数据堆叠，同个类目轴上系列配置相同的stack值
                    data: 	 //手机型号二相对应的销售量数据
                },
                {
                    name: '',   //手机型号三名称
                    type: '',   //图表类型，本实例推荐使用折线图
                    areaStyle: ,//区域填充样式，可为空对象，但要占位
                    stack: '',  //数据堆叠，同个类目轴上系列配置相同的stack值
                    data: 	  //手机型号三相对应的销售量数据
                }
            ]
  ```

  - 参数：无
  - 返回值：series数组



### 3. 在Pycharm中运行后台程序，生成网站地址，使用Chrome浏览器访问并查看显示效果



## 任务六、编写分析报告

根据数据可视化显示内容，按照分析报告模板要求完成数据分析报告。请结合数据分析结果回答以下问题：

- 问题一：销售量排名前三的手机型号的销售高峰在哪个时间段？
- 问题二：销量排名前十的手机型号的销售渠道是什么？
- 问题三：销售量排名前十的手机型号的用户评分情况？

某厂商生产一款新的手机，你建议该厂商应该在哪个时间段做产品的促销活动效果最好？如果要给不同的手机销售渠道提供折扣，你建议给哪个渠道提供最高的折扣能够最大程度的促进销售量？